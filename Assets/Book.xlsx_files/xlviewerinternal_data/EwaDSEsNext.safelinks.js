'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[64],{1453:function(t,E,a){a.r(E);var c=a(9);t=a(0);var b=a(4);E=a(222);var e=a(15),f=a(84);class d{constructor(L,P,aa,U,K,Y){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=L;this.WebAffinitizedUrl=P;this.PolicyCookie=aa;this.PolicyCookieTTL=U;this.WasServiceDown=K;this.AffinitizedUrl=Y}}Object(t.a)(d,
"SafeLinksData",null,[]);class h{constructor(L,P){this.CCc=L;this.stopwatch=P}}Object(t.a)(h,"SafeLinksGetUrlReputationRequestData",null,[]);var m=a(41),l=a(39);class w{constructor(L,P,aa,U){this.nb=L;this.Ah=P;this.Axg=aa;w.Ch=U}xCa(L,P,aa){try{var U=null;w.Ch&&(U=w.Ch.Cc("WebServiceCall","SafeLinksGetUrlReputation"));const K=new h(P,U);U={};U.AffinitizedUrl=L;U.TargetUrl=P;U.PolicyCookie=aa;const Y=m.c(U);this.Ah.Om(this.Axg,2,Y,null,!1,2,Object(f.a)(this,this.yTi,"onGetUrlReputationSuccessCallback"),
Object(f.a)(this,this.xTi,"onGetUrlReputationFailureCallback"),K,void 0,void 0,3E3,3E3,"36");return!0}catch(K){e.ULS.sendTraceTag(588788033,378,10,K.message)}return!1}yTi(L){let P="OnGetUrlReputationSuccessCallback: ",aa=10;const U=L.data.state;try{const K=m.b(L.data.fe).reputationResults[0],Y=K.navigateUrl.length,na=U.CCc.length,W=K.navigateUrl===U.CCc;K.navigateUrl&&0<K.navigateUrl.length&&(U.CCc=K.navigateUrl);P+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
L.data.httpStatus,K.verdict,na.toString(),Y.toString(),W.toString());aa=50}catch(K){P+=String.format("Exception {0}",K.message)}this.Haf(U,P,aa)}xTi(L){let P="OnGetUrlReputationFailureCallback: ";const aa=L.data.state;try{P+=String.format("HttpStatus {0}",L.data.httpStatus)}catch(U){P+=String.format("Exception {0}",U.message)}this.Haf(aa,P,10)}Haf(L,P,aa){L.stopwatch&&(L.stopwatch.stop(),L.stopwatch=null);e.ULS.sendTraceTag(588788034,378,aa,P);l.a.kf(L.CCc,void 0,"noopener,noreferrer","SafeLinksNav")}}
w.Ch=null;Object(t.a)(w,"SafeLinksNavigationHelper",null,[]);var n;(function(L){L[L.enabledByPolicy=0]="enabledByPolicy";L[L.disabledByPolicy=1]="disabledByPolicy";L[L.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";L[L.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(n||(n={}));Object(t.b)("SafeLinksNavigationState",n);var x=a(98),r=a(135),u=a(821),v=a(253),B=a(241),z=a(688),A=a(27),y=a(171),D=a(189);class I{constructor(L,P,aa,U=!1,K=null,Y=null){this.BEa=this.AEa=
0;this.lBb=this.dVb=!1;this.xra=null;this.LXa=!0;this.HYb=null;e.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.nb=L;this.Ah=P;this.Spa=aa;I.Ch=Y;this.DGg=U?this.nb.Xa("SafeLinksHandlerWebServiceBase"):this.nb.Xa("WebServiceBase");this.lGg=this.nb.Xa("SafeLinksHashedUserId");this.q5j=this.nb.Xa("SafeLinksWorkloadIdHeaderValue");this.BWb=this.nb.ud("SafeLinksMaxGetPolicyBootRetries",2);this.CWb=this.nb.ud("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.HVb=this.isSafeLinksEnabledForUser();
this.GVb=this.Wsi();e.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.HVb,this.GVb);if(this.HVb&&this.GVb){P=(L=this.a5a())?L.IsSafeLinksEnabled.toLowerCase():"";aa=this.itd();e.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",P,aa);var na=!L||"unknown"===P||L.WasServiceDown||aa,W=r.a.gs();W&&(W.set("shouldGetSafeLinksDataFromServer",na.toString()),W.set("isSafeLinksEnabledCacheValue",
P.toString()));K?(this.LXa=!1,K.execute(X=>{X.isFeatureEnabled("MsoUrlreputation",!0).then(Aa=>{this.LXa=Aa;W.set("isUserLicensedForSafeLinks",this.LXa.toString());x.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",W);this.LXa&&na&&this.oec(!0);return null})})):(x.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",W),na&&this.oec(!0))}}get appName(){return this.Spa}get mGc(){return this.DGg}get userId(){return this.lGg}get O_h(){const L=this.mGc?this.mGc+
"/":"",P=new v.QueryStringBuilder("SafeLinksHandler.ashx");P.oj("app",this.appName);this.nb.qa("SafeLinksUseDebugHeader")&&P.oj("action","debug");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&P.oj("s2satpop","1");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&P.oj("s2se03","1");return String.format("{0}{1}&{2}",L,P.toString(),b.AFrameworkApplication.Hi)}get G5h(){const L=this.mGc?this.mGc+"/":"",P=new v.QueryStringBuilder("SafeLinksHandler.ashx");
P.oj("app",this.appName);this.nb.qa("SafeLinksUseDebugHeader")&&P.oj("action","debug");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&P.oj("s2satpop","1");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&P.oj("s2saat","1");this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&P.oj("s2se03","1");P.oj("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",L,P.toString(),b.AFrameworkApplication.Hi)}get IJi(){I.sTc||
(I.sTc=new w(this.nb,this.Ah,this.G5h,I.Ch));return I.sTc}xCa(L){if(!L)return e.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var P=this.npi(L);e.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",P,this.HVb,this.GVb,this.LXa);if(!(P&&this.HVb&&this.GVb&&this.LXa))return!1;P=0;const aa=({state:P}=this.eGj()).returnValue;e.ULS.sendTraceTag(595079385,
378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",n[P]);const U=r.a.gs();U&&U.set("SafeLinksNavigationState",n[P]);x.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",U);if(!aa)return 2!==P&&3!==P||x.Health.instance.recordKpiFailure("SafeLinksNavigations",n[P],!1,!0,null),!1;e.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.mGj())return this.itd()?!1:this.IJi.xCa(this.oOh(),L,this.g7e());if(!this.itd())return this.qhg(L),!0;
this.xra=L;e.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.lBb=!1;this.oec();return!0}npi(L){L=L.toLowerCase();const P=this.nb.Fw("SafeLinksUnsupportedProtocols");if(P)for(let aa=0;aa<P.length;aa++)if(L.startsWith(P[aa]))return!1;return!0}oec(L=!1){var P=r.a.gs();P&&P.set("isOnBootRequest",L.toString());x.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",P);x.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",
0,"jpittsdirects",P);P=this.w6c("SafeLinksGetPolicy");this.Ah.Om(this.O_h,1,null,null,!0,2,Object(f.a)(this,this.h2h,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(f.a)(this,this.g2h,"getSafeLinksDataFromServer_OnFailureCallback"),P,void 0,void 0,void 0,void 0,"23");this.lBb=L;this.dVb=!0;L?this.AEa++:this.BEa++}h2h(L){let P=B.a.GKi,aa="";try{this.dVb=this.lBb=!1;var U=L.data.state;const Ca=({stopwatch:U}=this.MBc(U)).returnValue,ia=Object.assign(new D.a,{durationMs:Ca});x.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",
ia);e.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",L.data.httpStatus,L.data.fe.length,Ca);if(L.data.httpStatus!==B.a.wP)aa="Unexpected httpStatus: "+L.data.httpStatus.toString();else{U=null;try{U=m.b(L.data.fe)}catch(Ra){aa="Exception:"+Ra.toString()+" deserializing response";return}if(U){var K=U.IsSafeLinksEnabled;if(void 0===K||null===K||0>=K.length)aa="Invalid isSafeLinksEnabledString";else{e.ULS.sendTraceTag(594830613,
378,50,"Retrieved isSafeLinksEnabledString {0}",K);var Y=I.VGd(K);if(void 0===U.WebAffinitizedUrl||null===U.WebAffinitizedUrl||0>=U.WebAffinitizedUrl.length)aa="Invalid WebAffinitizedUrl";else if(void 0===U.PolicyCookie||null===U.PolicyCookie||0>=U.PolicyCookie.length)aa="Invalid PolicyCookie";else if(void 0===U.PolicyCookieTTL||null===U.PolicyCookieTTL)aa="Invalid PolicyCookieTTL";else{var na=U.WebAffinitizedUrl,W=U.PolicyCookie,X=U.AffinitizedUrl,Aa=new Date;Aa.setMinutes(Aa.getMinutes()+(5<U.PolicyCookieTTL?
U.PolicyCookieTTL-5:0));var Q=Aa.getTime(),fa=new d(K,na,W,Q,!1,X);this.q4f(fa);P=L.data.httpStatus;this.xra&&(Y?(this.qhg(this.xra),this.BEa=this.AEa=0):(e.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),x.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),l.a.oV(this.xra)),this.xra=null)}}}else aa="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Ca){aa="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+
Ca.toString()}finally{P!==B.a.wP&&this.Gaf(P,aa)}}g2h(L){this.dVb=!1;let P=500,aa="";try{let U=L.data.state;const K=({stopwatch:U}=this.MBc(U)).returnValue,Y=Object.assign(new D.a,{durationMs:K});P=L.data.httpStatus;x.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+P.toString(),!1,!0,Y);aa="Request Failed, Status="+z.a[L.data.status]+" Duration: "+K}catch(U){aa="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+U.toString()}finally{this.Gaf(P,aa)}}Gaf(L,
P=""){try{if(e.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",L,P),this.AEa<this.BWb&&this.BEa<this.CWb)this.oec(this.lBb);else{this.lBb=!1;e.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.AEa,this.BEa,L,P);P=null;const aa=r.a.gs();aa&&(aa.set("HttpStatus",L.toString()),P=Object.assign(new D.a,{extendedProperties:aa}));x.Health.instance.recordKpiFailure("SafeLinksGetPolicy1",
"GetPolicyRequestError",!1,!0,P);const U=new d("false","","",0,!0,"");this.q4f(U);this.xra&&(e.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),x.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),l.a.oV(this.xra),this.xra=null)}}catch(aa){e.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",aa.toString())}}qhg(L){const P=this.g7e(),aa=this.s6h(),
U={};U.Url=L;U.SafeLinksCookie=P;U.CorrelationId=y.a.create().toString();U.WorkloadId=this.q5j;U.UserAgentInfo=A.a.IHa+"|"+this.appName;e.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",U.CorrelationId);l.a.gtc(l.a.TX(4),aa,U)}isSafeLinksEnabledForUser(){const L=this.nb.Xa("IsSafeLinksEnabledForUser");return L?I.VGd(L):!1}Wsi(){const L=this.nb.Fw("SafeLinksDisabledBrowsers");if(A.a.Hz){if(this.nb.cq("SafeLinksForTeamsIsEnabled")&&this.nb.qa("SafeLinksForTeamsIsEnabled"))return!0;
if(Array.contains(L,"Electron"))return!1}else if(Array.contains(L,A.a.IHa))return!1;return"officecomhwa"===(this.nb.Xa(b.AFrameworkApplication.o8)||"").toLowerCase()?!1:!0}mGj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.nb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&A.a.H5?!0:A.a.Hz}eGj(){let L;L=0;const P=this.a5a(),aa=P?P.IsSafeLinksEnabled:"";if(""!==aa)return P.WasServiceDown?(e.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),
{returnValue:!1,state:2}):"false"===aa.toLowerCase()?(e.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:I.VGd(aa),state:L};if(this.dVb)return L=3,e.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:L};if(this.AEa>=this.BWb||this.BEa>=this.CWb)return L=2,e.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.AEa,this.BWb,
this.BEa,this.CWb),{returnValue:!1,state:L};e.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.BWb+this.CWb-(this.AEa+this.BEa));return{returnValue:!0,state:L}}g7e(){const L=this.a5a();return L?L.PolicyCookie:""}s6h(){const L=this.a5a();return L?L.WebAffinitizedUrl:""}oOh(){const L=this.a5a();return L?L.AffinitizedUrl:""}tUh(){const L=new Date;try{const P=
this.a5a();L.setTime(P?P.PolicyCookieTTL:0)}catch(P){e.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",P)}return L}itd(){const L=this.tUh();return!!L&&L.getTime()<Date.now()}a5a(){if(!this.HYb){const L=u.a.instance.getItem(this.userId);if(!L||""===L)return null;this.HYb=JSON.parse(L)}return this.HYb}q4f(L){if(void 0===L||null===L)throw Error.argumentNull("safeLinksData");if(void 0===L.IsSafeLinksEnabled||null===L.IsSafeLinksEnabled||0>=L.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");
this.HYb=L;L.WasServiceDown||this.z5j(L)}z5j(L){L=JSON.stringify(L);u.a.instance.setItem(this.userId,L)}w6c(L){return void 0!==I.Ch&&null!==I.Ch?I.Ch.Cc("WebServiceCall",L):null}MBc(L){if(void 0!==L&&null!==L){const P=L.Bc;L.stop();return{returnValue:P,stopwatch:null}}return{returnValue:null,stopwatch:L}}static VGd(L){return"false"!==L.toLowerCase()?!0:!1}}I.Ch=null;I.sTc=null;Object(t.a)(I,"SafeLinksManager",null,[743]);const M=L=>{switch(L){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";
default:return"Unknown"}},T=L=>{switch(L){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};var S=a(698);class H extends E.a{constructor(L){super();this.$=L;this.Fb()}create(){const L=Object(S.a)(this.$.da,269,()=>new I(b.AFrameworkApplication.fa,b.AFrameworkApplication.zd,`${M(b.AFrameworkApplication.ta.Pa.Ij)}-${T(b.AFrameworkApplication.ta.Pa.E6)}`));this.ob(L)}static la(L){L.da.Ga(270,new H(L))}}Object(t.a)(H,"SafeLinksManagerFactory",E.a,[]);var C=a(1),
G=a(229),J=a(217);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(()=>{C.EwaSettings.Osd()?Object(J.b)(G.c,{HOa:"singleton"})(()=>new I(b.AFrameworkApplication.fa,b.AFrameworkApplication.zd,String.format("{0}-{1}",M(b.AFrameworkApplication.ta.Pa.Ij),T(b.AFrameworkApplication.ta.Pa.E6)))):c.a.Fa(L=>{H.la(L)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.safelinks.js.map/989e940086736f7f7a8de0ac1afb9c9d/EwaDSEsNext.safelinks.js.map